<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ScanClass - Cadastro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Barlow&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="login-page">
    <div class="login-container">
      <div class="login-box">
        <h1 class="logo">ScanClass</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-3">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <h2 class="text-center">Capture seu rosto para concluir o cadastro</h2>

        <div class="mb-2">
          <input id="name" class="form-control mb-2" type="text" placeholder="Nome completo" />
          <input id="nameUser" class="form-control mb-2" type="text" placeholder="Nome de usuário" />
          <input id="email" class="form-control mb-2" type="email" placeholder="E-mail" />
          <input id="password" class="form-control mb-2" type="password" placeholder="Senha" />
        </div>

        <video id="video" class="w-100 mb-2" style="border:1px solid #ccc; border-radius:8px; display:none;" playsinline></video>
        <button type="button" class="btn btn-success w-100 mb-3" id="btnCapturarRosto">Capturar rosto</button>
        <canvas id="canvas" style="display:none;"></canvas>

        <div class="signup-box mt-3 text-center">
          <p>Já tem uma conta? <a href="{{ url_for('login') }}">Faça login</a></p>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const video = document.getElementById('video');
        const btn = document.getElementById('btnCapturarRosto');
        const canvas = document.getElementById('canvas');
        let stream = null;
        let capturing = false;

        async function stopStream() {
          if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
          }
          if (video) {
            video.srcObject = null;
            video.style.display = 'none';
          }
        }

        async function capturarRosto() {
          if (capturing) return;
          capturing = true;
          btn.disabled = true;

          const nome = document.getElementById('name').value.trim();
          const usuario = document.getElementById('nameUser').value.trim();
          const email = document.getElementById('email').value.trim();
          const senha = document.getElementById('password').value.trim();

          if (!nome || !usuario || !email || !senha) {
            alert("Preencha todos os campos antes de capturar o rosto!");
            capturing = false;
            btn.disabled = false;
            return;
          }

          try {
            if (!stream) {
              stream = await navigator.mediaDevices.getUserMedia({ video: true });
              video.srcObject = stream;
              video.style.display = 'block';
              try { await video.play(); } catch(e){}
            }

            await new Promise(res => setTimeout(res, 500));

            const w = video.videoWidth || 640;
            const h = video.videoHeight || 480;
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, w, h);

            const dataURL = canvas.toDataURL('image/jpeg', 0.9);

            const resp = await fetch('/salvar_rosto', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ nome, usuario, email, senha, imagem: dataURL })
            });

            let json;
            try { json = await resp.json(); } catch(e){ json = { mensagem: 'Resposta inválida do servidor.' }; }

            if (json.redirect) {
              await stopStream();
              window.location.href = json.redirect;
              return;
            }

            if (json.mensagem) alert(json.mensagem);
            else alert(JSON.stringify(json));

          } catch (err) {
            console.error('Erro ao capturar/enviar rosto:', err);
            alert('Erro ao acessar a câmera ou enviar a imagem: ' + (err.message || err));
          } finally {
            await stopStream();
            capturing = false;
            btn.disabled = false;
          }
        }

        if (btn) btn.addEventListener('click', capturarRosto);
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
