<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ScanClass - Login</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Barlow&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="login-page">
    <div class="login-container">
      <div class="login-box">
        <h1 class="logo">ScanClass</h1>

        <!-- Mensagens flash do Flask -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-3">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Formulário tradicional -->
        <form id="formLogin" method="POST" action="{{ url_for('login') }}">
          <div class="mb-2">
            <label for="inputText" class="form-label visually-hidden">E-mail ou usuário</label>
            <input
              id="inputText"
              class="form-control"
              type="text"
              name="usuario"
              placeholder="E-mail ou nome de usuário"
              required
              autocomplete="username"
            />
            <div id="fidelErrorInputText" class="text-danger mt-1"></div>
          </div>

          <div class="mb-3">
            <label for="password" class="form-label visually-hidden">Senha</label>
            <input
              id="password"
              class="form-control"
              type="password"
              name="senha"
              placeholder="Senha"
              required
              autocomplete="current-password"
            />
            <div id="fidelErrorPassword" class="text-danger mt-1"></div>
          </div>

          <div class="d-grid mb-2">
            <button class="btn btn-primary" type="submit">Entrar</button>
          </div>

          <div class="text-center">
            <a href="#" class="forgot-password">Esqueceu a senha?</a>
          </div>
        </form>

        <hr>

        <!-- Login por reconhecimento facial -->
        <h2 class="text-center">Dar entrada no sistema</h2>
        <video id="video" autoplay class="w-100 mb-2" style="border:1px solid #ccc; border-radius:8px;"></video>
        <button class="btn btn-success w-100 mb-3" id="btnDarEntrada">Dar entrada</button>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>

      <div class="signup-box mt-3 text-center">
        <p>Não tem uma conta? <a href="{{ url_for('cadastro') }}">Cadastre-se</a></p>
      </div>
    </div>

    <div class="flash-camera" id="flash"></div>

    <!-- Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const formLogin = document.getElementById("formLogin");
        const inputText = document.getElementById("inputText");
        const password = document.getElementById("password");
        const errorInputText = document.getElementById("fidelErrorInputText");
        const errorPassword = document.getElementById("fidelErrorPassword");
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const btnDarEntrada = document.getElementById("btnDarEntrada");

        // Validação e envio do formulário
        formLogin.addEventListener("submit", (e) => {
          e.preventDefault();

          let erros = {};
          const valorUsuario = inputText.value.trim();
          const valorSenha = password.value.trim();

          const regexEmail = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
          const regexName = /^[a-zA-Z\s]+$/;

          if (!valorUsuario) {
            erros.usuario = "Campo obrigatório";
          } else if (!regexEmail.test(valorUsuario) && !regexName.test(valorUsuario)) {
            erros.usuario = "Digite um nome ou e-mail válido";
          }

          if (!valorSenha) {
            erros.senha = "Campo obrigatório";
          }

          errorInputText.textContent = erros.usuario || "";
          errorPassword.textContent = erros.senha || "";

          if (Object.keys(erros).length === 0) {
            formLogin.submit();
          }
        });

        // Captura de rosto para dar entrada
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => { video.srcObject = stream; })
          .catch(err => { alert("Erro ao acessar a câmera: " + err); });

        btnDarEntrada.addEventListener("click", () => {
          const usuario = inputText.value.trim();
          if (!usuario) {
            alert("Digite seu usuário antes de dar entrada.");
            return;
          }

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0);

          const dataURL = canvas.toDataURL("image/jpeg");

          fetch("/reconhecimento_facial", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ imagem: dataURL, acao: 'entrada' })
          })
          .then(res => res.json())
          .then(data => alert(data.mensagem))
          .catch(err => alert("Erro ao verificar rosto: " + err));
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
